{% extends 'base.html' %}
<!-- <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script> -->

{% block body %}
    
    <h1>This is item {{item.item_name}}</h1>
    <h1><b>Category:</b>  {{item.item_category}}</h1>
    <h1><b>Description:</b>  {{item.item_description}}</h1>
    
    <h1><b>Starts At:</b> <span id="start-time-local"></span></h1>
    <h1><b>Ends At:</b>  <span id="end-time-local"></span></h1>
    <h1><b>Starting Price:</b>  {{item.starting_price}}</h1>
    <h1><b>Location:</b>  {{item.seller_id.city}}</h1>
    
    <hr>
    <table>
      <tr>
        <th class="cells">Name </th>
        <th class="cells">Bid Amount</th>
        <th class="cells">Time</th>

      </tr>
      {% for i in bids %}
        <tr>
          <td class="cells">{{i.bidder_id.fname}}</td>
          <td class="cells">{{i.bid_price}}</td>
          <td class="cells">{{i.bid_time}}</td>

        </tr>
      {% endfor %}
      </table>
    <script>var startTime = new Date('{{item.start_time|date:"c"}}');
      $("#start-time-local").html(startTime.toLocaleString());
      var endTime = new Date('{{item.end_time|date:"c"}}');
      $("#end-time-local").html(endTime.toLocaleString());

    </script>


    <h1><b>Photos:</b></h1>
    {% for i in images %}
        <img src="{{i.image.url}}">
    {% endfor %}
    
    {% if expired_flag %}
    <p>Final Bid: <b>$>$<span id="item_price">{{item.current_bid}}</span></b></p>
    {% else %}  
    <p>Current Bid: <b>$<span id="item_price">{{item.current_bid}}</span></b></p>
    {% endif %}
      

    {% if payment_exists and expired_flag is False %}
    
    <form action='{% url "place_bid" %}' method="post">
    {% csrf_token %}
        <input type="hidden" name="item_id" value="{{item.item_id}}">
        <input required  type="number" id="bid_amount" name="bid_amount" step="  50" min="{{item.current_bid|add:50}}">
        <input type="hidden" name="next" value="{{request.path}}">
        <button type="submit" id="place_bid" class="btn btn-primary" >Bid</button>
    </form> 
    {% elif expired_flag %}
    <button disabled type="button" class="btn btn-primary">Bid</button>
    <p>You cannot bid, This auction has been expired</p>
    {% else %}
        <p> Add a payment method to start bidding</p>
      <form action="{% url 'add_payment' %}" method="GET">
        <input type="hidden" name="next" value="{{request.path}}">
        <button id="add_payment" name='add_payment' type="submit" class="btn btn-primary" >Add Payment</button>
      </form>

    {% endif %}
    <br> 
    <button id="wish" type="button" class="btn btn-primary" >Add to wishlist</button>
    <button id="rmwish" type="button" class="btn btn-primary" >Remove from wishlist</button>





{% endblock body %}

{% block style %}
.cells {
  border: 5px solid black;
}        

{% endblock style %}


{% block javascript %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>    
<script>
  

    $(document).ready(function(){    
      let textbox = document.querySelector("#new_bid");
      setInterval(function () {
       $.ajax({
            type: "get",
            url: "{% url 'get_auction_item_price' item.item_id %}",
            success:function (data) {
                //console.log the response
                console.log(data);
                //update the contents of a <p> tag
                $('#item_price').text(data.price);
                $('#bid_amount').attr({"min": data.price+50});
                

              }
          });
      }, 10000);



    $.ajax({
      url: '{% url "is_wishlisted" %}',
      data: {"user": "{{request.user}}",
      "item_id":  "{{item.item_id}}",
        "type": "auction"},
      dataType: 'json',
      success: function (data) {
      if (data.auction_item_exists) {
        $("#wish").html('Added to Wishlist');
        $("#rmwish").show();
      }

      else {
        $("#wish").html('Add to Wishlist');
        $("#rmwish").hide();
      }
      }

    });
    
    /*$("#place_bid").click(function () {
      $.ajax({
        url: '{% url "place_bid" %}',
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
        data: jQuery.param({"auction_item_id": $("#item_id").val(),
                "bid_amount": $("#bid_amount").val(),
                "user_id": "{{request.user}}",
                "crsf_token": $("input[name='csrfmiddlewaretoken']").val()
            }),
        success: function() {console.log('success');},
        error: function() {alert('Some error occured');}

      });
    })*/


    $("#rmwish").click(function () {
      $.ajax({
        url: '{% url "remove_from_wish" %}',
        data: {"user": "{{request.user}}",
               "item_id":  "{{item.item_id}}",
                "type": "auction"},
        dataType: 'json',
        success: function (data) {
          if (data.auction_item_exists == false) {
            $("#wish").html('Add to Wishlist');
            $("#rmwish").hide();
          }
        }
      });

    })

    $("#wish").click(function () {
        $.ajax({
          url: '{% url "add_to_wish" %}',
          data: {"user": "{{request.user}}",
                 "item_id":  "{{item.item_id}}",
                 "type": "auction"},

          dataType: 'json',
          success: function (data) {
            if (data.auction_item_added_success) {
              $("#wish").html('Added to Wishlist');
              $("#rmwish").show();
            }

            else {
              $("#wish").html('Add to Wishlist');
              $("#rmwish").hide();
            }
          }
          
        });
  
      })
    });
</script>

{% endblock javascript %}
 